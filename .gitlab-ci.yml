include:
  - template: Security/SAST.gitlab-ci.yml

image: node:18.14-alpine

stages:
  - build
  - test

cache: &global_cache
  # Cache NextJS files: https://nextjs.org/docs/messages/no-cache#gitlab-ci
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .next/cache/
    - node_modules
    - .yarn
  policy: pull

build:
  stage: build
  script:
    - yarn -v
    - yarn install --cache-folder .yarn --frozen-lockfile
    - yarn run build
  cache:
    # inherit all global cache settings
    <<: *global_cache
    # override the policy
    policy: pull-push

lint-code:
  stage: test
  script:
    - yarn run lint
    - yarn run check-format

unit-test:
  stage: test
  script:
    - 'yarn global add jest'
    - 'yarn add --dev jest-junit'
    - 'jest --ci --reporters=default --reporters=jest-junit'
  artifacts:
    when: always
    reports:
      junit:
        - junit.xml